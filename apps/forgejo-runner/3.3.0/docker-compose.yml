version: '3'
services:
  docker-in-docker:
    image: docker:dind
    privileged: true
    command: [ "dockerd", "-H", "tcp://0.0.0.0:2375", "--tls=false" ]
    
  runner-register:
    image: code.forgejo.org/forgejo/runner:3.3.0
    links:
      - docker-in-docker
    environment:
      DOCKER_HOST: tcp://docker-in-docker:2375
    volumes:
      - ./runner_data:/data
    user: 0:0
    command: >-
      bash -ec '
      while : ; do
        forgejo-runner create-runner-file --connect --instance ${FORGEJO_INSTANCE} --name ${FORGEJO_RUNNER_NAME} --secret ${FORGEJO_RUNNER_SECRET} && break ;
        sleep 1 ;
      done ;
      forgejo-runner generate-config > config.yml ;
      sed -i -e "s|network: .*|network: host|" config.yml ;
      sed -i -e "s|labels: \[\]|labels: \[\"docker:docker://alpine:3.18\"\]|" config.yml ;
      chown -R 1000:1000 /data
    networks:
      - 1panel-network

  runner-daemon:
    image: code.forgejo.org/forgejo/runner:3.3.0
    container_name: ${CONTAINER_NAME}
    links:
      - docker-in-docker
    environment:
      DOCKER_HOST: tcp://docker-in-docker:2375
    depends_on:
      runner-register:
        condition: service_completed_successfully
    volumes:
      - ./runner_data:/data
    command: "forgejo-runner --config config.yml daemon"
    labels:
      createdBy: "Apps"
    restart: always
    networks:
      - 1panel-network
networks:
  1panel-network:
    external: true