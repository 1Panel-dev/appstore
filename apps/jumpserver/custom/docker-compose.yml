version: '3.8'
services:
  jumpserver:
    image: jumpserver/jms_all:${VERSION}
    container_name: ${CONTAINER_NAME}
    privileged: true
    restart: always
    environment:
      SECRET_KEY: ${SECRET_KEY}
      BOOTSTRAP_TOKEN: ${BOOTSTRAP_TOKEN}
      DEBUG: ${DEBUG:-FALSE}
      LOG_LEVEL: ${LOG_LEVEL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      MAGNUS_MYSQL_PORT: ${MAGNUS_MYSQL_PORT}
      MAGNUS_MARIADB_PORT: ${MAGNUS_MARIADB_PORT}
      MAGNUS_REDIS_PORT: ${MAGNUS_REDIS_PORT}
    ports:
      - ${HTTP_PORT}:80
      - ${SSH_PORT}:2222
      - ${MAGNUS_MYSQL_PORT}:33061
      - ${MAGNUS_MARIADB_PORT}:33062
      - ${MAGNUS_REDIS_PORT}:63790
    healthcheck:
      test: "curl -fsL http://localhost/api/health/ > /dev/null"
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    volumes:
      - ${VOLUME_DIR}/core/data:/opt/jumpserver/core/data
      - ${VOLUME_DIR}/koko/data:/opt/jumpserver/koko/data
      - ${VOLUME_DIR}/lion/data:/opt/jumpserver/lion/data
      - ${VOLUME_DIR}/magnus/data:/opt/jumpserver/magnus/data
      - ${VOLUME_DIR}/nginx/data:/var/log/nginx
    networks:
      - 1panel-network

networks:
  1panel-network: